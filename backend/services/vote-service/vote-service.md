### Vote-service :
Сервис отвечает за «живую» очередь треков и голосование за следующий трек.

Этот сервис получает `X-User-Id` от API Gateway (который проверяет JWT).
Все пользовательские эндпоинты доступны только через API Gateway.

### Основные функции

**События (events):**
- создание голосования (события):
  - `name` — имя события: "Friday Party", "Main Stage"…
  - `visibility` — публичность события: `public` / `private`
  - `licenseMode` — режим голосования:
    - `everyone` — голосовать могут все, кто видит событие
    - `invited_only` — голосовать могут только приглашённые
    - `geo_time` — голосовать могут только люди **в определённом месте** и **в определённое время**
- гео-настройки (для `geo_time`):
  - `geoLat`, `geoLng` — центр события
  - `geoRadiusM` — радиус в метрах (например, 50–200 м для бара/сцены)
- окно голосования:
  - `voteStart` — начало голосования (дата/время)
  - `voteEnd` — конец голосования


**Правила времени (валидация):**
- нельзя создать/изменить событие так, чтобы:
  - `voteStart` или `voteEnd` был **в прошлом**;
  - `voteStart` или `voteEnd` были **дальше, чем на 1 год вперёд**;
  - если заданы оба: `voteEnd` – `voteStart` **< 1 часа**.
- если `voteStart`/`voteEnd` не заданы — сервер не ограничивает голосование по времени (кроме бизнес-логики лицензии).


**Видимость событий:**
- `public` — публичное событие:
  - может попадать в общий список `/events` для всех авторизованных пользователей;
  - но голосование всё равно подчиняется лицензии (`everyone` / `invited_only` / `geo_time`).
- `private` — приватное событие:
  - видно только:
    - владельцу (`ownerId`),
    - приглашённым пользователям.
  - остальные получают 404, чтобы не показывать приватные события.


**Инвайты (приглашения):**
- владелец события может:
  - приглашать пользователей по их `userId`;
  - удалять приглашения;
  - просматривать список приглашённых.
- vote-service **проверяет существование пользователя** в user-service:
  - делает внутренний запрос в user-service
  - если `userId` не существует → ошибка `404 user not found`, инвайт не создаётся.


**Голосование:**
- голос идёт за конкретный `trackId` (идентификатор трека).
- **один пользователь — один голос на событие**:
  - изменить или удалить голос нельзя;
  - повторная попытка → `409 duplicate vote`.
- владелец события тоже голосует **только один раз**.
- доступ к голосованию зависит от:
  - публичность события (`public`/`private`),
  - лицензия (`everyone` / `invited_only` / `geo_time`),
  - геопозиция и время (для `geo_time`).


**Geo + Time (лицензия `geo_time`):**
- сервер проверяет:
  - текущее время в окне `[voteStart, voteEnd]`;
  - координаты пользователя (`lat`, `lng`) в пределах `geoRadiusM` от центра события.
- если пользователь:
  - **не в радиусе** → `403 user is outside of allowed geo area`;
  - **голосование ещё не началось** → `403 voting has not started yet`;
  - **голосование уже закончено** → `403 voting has ended`.

**Важно:**  
автор события (`ownerId`) **может голосовать всегда** (вне зависимости от лицензии, радиуса и времени) — но всё равно **только один раз**.


**Tally (подсчёт голосов):**
- можно получить список треков и количество голосов по событию;
- фронт/мобилка могут на основе этого пересчитывать live-очередь.

---

## Эндпоинты (только через API Gateway)
Все запросы предполагают, что API Gateway:
- валидирует JWT,
- подставляет `X-User-Id` в запрос на vote-service.

---

`GET /events`
Список событий, доступных текущему пользователю.
- все события с `visibility = public`;
- плюс события, где пользователь:
  - владелец (`ownerId == userId`),
  - или приглашён (есть запись в инвайтах).
ex respons :
```json
[
  {
    "id": "event-uuid",
    "name": "Friday Party",
    "visibility": "public",
    "ownerId": "user-uuid",
    "licenseMode": "geo_time",
    "geoLat": 48.8566,
    "geoLng": 2.3522,
    "geoRadiusM": 100,
    "voteStart": "2025-11-27T14:00:00Z",
    "voteEnd": "2025-11-27T16:00:00Z",
    "createdAt": "...",
    "updatedAt": "..."
  }
]
```
Ошибки:
- 401 — нет/невалидный JWT → gateway не пускает.


`POST /events`
Создать новое событие (голосование).
ex body :
```json
{
  "name": "Friday Party",
  "visibility": "public",
  "licenseMode": "geo_time",
  "geoLat": 48.8566,
  "geoLng": 2.3522,
  "geoRadiusM": 100,
  "voteStart": "2025-11-27T14:00:00Z",
  "voteEnd": "2025-11-27T16:00:00Z"
}
```

- name — обязательное.
- visibility — public (по умолчанию) или private.
licenseMode:
- everyone — голосуют все, кто видит событие;
- invited_only — голосуют только приглашённые;
- geo_time — голосуют только в радиусе и в окне времени.
- geoLat / geoLng / geoRadiusM — опционально, но для geo_time имеет смысл их указать.
- voteStart / voteEnd — опционально, но если указаны, работают правила:
- - не в прошлом,
- - не более года вперёд,
- - окно минимум 1 час.
```json
{
  "id": "event-uuid",
  "name": "Friday Party",
  "visibility": "public",
  "ownerId": "current-user-id",
  "licenseMode": "geo_time",
  "geoLat": 48.8566,
  "geoLng": 2.3522,
  "geoRadiusM": 100,
  "voteStart": "2025-11-27T14:00:00Z",
  "voteEnd": "2025-11-27T16:00:00Z",
  "createdAt": "...",
  "updatedAt": "..."
}
```
Ошибки:
- 400 — невалидные данные:
- voteStart/voteEnd в прошлом,
- слишком далеко в будущем,
- окно < 1 часа,
- voteEnd < voteStart и т.п.
- 401 — без авторизации.


`GET /events/{id}`
Получить информацию об одном событии.
```json
{
  "id": "event-uuid",
  "name": "Friday Party",
  "visibility": "public",
  "ownerId": "user-uuid",
  "licenseMode": "everyone",
  "geoLat": null,
  "geoLng": null,
  "geoRadiusM": null,
  "voteStart": null,
  "voteEnd": null,
  "createdAt": "...",
  "updatedAt": "..."
}
```
- если событие private и пользователь:
- не владелец,
- не приглашён → сервер возвращает 404, как будто события нет.
Ошибки:
- 401 — без авторизации.
- 404 — событие не найдено или недоступно.


`PATCH /events/{id}`
Изменить настройки события (только владелец).
Изменяется :
- name,
- visibility,
- licenseMode,
- geoLat / geoLng / geoRadiusM,
- voteStart / voteEnd (с теми же ограничениями по времени).
```json
{
  "visibility": "private",
  "licenseMode": "invited_only",
  "voteStart": "2025-11-27T20:00:00Z",
  "voteEnd": "2025-11-27T22:00:00Z"
}
```
Ошибки:
- 400 — невалидные данные / нарушены правила времени.
- 401 — без авторизации.
- 403 — пользователь не владелец.
- 404 — событие не найдено.


`DELETE /events/{id}`
Удалить событие (только владелец).
При удалении по каскаду удаляются все голоса и инвайты.
Ошибки:
- 401 — без авторизации.
- 403 — не владелец.
- 404 — событие не найдено.


`GET /events/{id}/invites`
Список приглашённых пользователей (только владелец).
```json
[
  {
    "userId": "invited-user-id",
    "createdAt": "2025-11-27T10:00:00Z"
  }
]
```
Ошибки:
- 401 — без авторизации.
- 403 — не владелец события.
- 404 — событие не найдено.


`POST /events/{id}/invites`
Пригласить пользователя в событие (только владелец).
```json
{
  "userId": "target-user-id"
}
```
- vote-service делает внутренний запрос в user-service, чтобы проверить, что userId существует.
- если инвайт уже был — это не ошибка, просто ничего не меняется.
Ошибки:
- 400 — невалидный userId.
- 401 — без авторизации.
- 403 — не владелец.
- 404 — событие или пользователь не найден (по результату проверки в user-service).


`DELETE /events/{id}/invites/{userId}`
Удалить приглашение (только владелец).
Ошибки:
- 401 — без авторизации.
- 403 — не владелец.
- 404 — событие не найдено (удаление несуществующего инвайта не считается ошибкой).


**Голосование**
`POST /events/{id}/vote`
Проголосовать за трек в событии.
```json
{
  "trackId": "spotify:track:123",
  "lat": 48.8566,
  "lng": 2.3522
}
```
- trackId — обязательный.
- lat / lng — опционально; для geo_time ожидается, что фронт их передаст с GPS устройства.
```json
{
  "status": "ok",
  "trackId": "spotify:track:123",
  "totalVotes": 5
}
```
- totalVotes — сколько всего голосов теперь у этого трека в рамках события.

Правила:
- один пользователь может проголосовать ровно один раз на событие:
- уникальный индекс в БД по (event_id, voter_id);
- вторая попытка → 409 Duplicate vote.
- автор события тоже подчиняется этому правилу (просто у него нет ограничений по geo/time/invite).
Ошибки:
- 400 — невалидный запрос (нет trackId, неверные координаты и т.п.).
- 401 — без авторизации.
- 403 — голосовать нельзя:
- пользователь не приглашён в приватное событие при invited_only,
- находится вне радиуса при geo_time,
- голосование ещё не началось / уже закончилось.
- 404 — событие не найдено.
- 409 — пользователь уже голосовал в этом событии.


`GET /events/{id}/tally`
Получить подсчёт голосов по событию.
```json
[
  { "track": "spotify:track:123", "count": 5 },
  { "track": "spotify:track:456", "count": 2 }
]
```
Фронт может на основе этого строить:
- live-очередь треков (сортировать по count),
- отображать прогресс голосования.
Ошибки:
- 401 — без авторизации.
- 404 — событие не найдено.

Структура данных (упрощённо)  
- events:
- - id — UUID
- - name
- - owner_id
- - visibility — public / private
- - license_mode — everyone / invited_only / geo_time
- - geo_lat / geo_lng / geo_radius_m
- - vote_start / vote_end
- - created_at / updated_at

- event_invites:
- - event_id
- - user_id
- - created_at

- votes:
- - id
- - event_id
- - track (строковый ID трека)
- - voter_id (строковый ID пользователя)
- - created_at
- - UNIQUE (event_id, voter_id, track) — один голос за трек;
- - UNIQUE индекс (event_id, voter_id) — один голос на событие.

- Безопасность
- - Vote-service не знает ничего о JWT.
- - Этим занимается API Gateway.
- - Пользовательский контекст всегда приходит через заголовок X-User-Id.

- Приватность событий:
- - приватное событие не попадает в список /events для посторонних;
- - по GET /events/{id} посторонний увидит 404.
- - Проверка существования userId при приглашении идёт через внутренний HTTP-запрос в user-service:
- - внешние клиенты не имеют доступа к этому эндпоинту.