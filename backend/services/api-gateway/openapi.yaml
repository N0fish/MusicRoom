openapi: 3.0.3
info:
  title: Music Room Gateway API
  version: 1.0.0

servers:
  - url: http://localhost:8080
    description: Local development gateway

paths:
  /health:
    get:
      summary: Health check for API gateway
      tags: [system]
      responses:
        '200':
          description: Gateway is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  service:
                    type: string
                example:
                  status: ok
                  service: api-gateway

  # --------------------
  # AUTH: email + password, tokens
  # --------------------
  /auth/register:
    post:
      summary: Register a new user with email and password
      tags: [auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '201':
          description: User successfully registered, tokens returned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthTokens'
        '400':
          description: Invalid input data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Email already registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/login:
    post:
      summary: Login with email and password
      tags: [auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login successful, returns tokens
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthTokens'
        '400':
          description: Invalid input data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '429':
          description: Too many login attempts from this IP (rate limited by API Gateway)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/refresh:
    post:
      summary: Refresh access token using refresh token
      tags: [auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshRequest'
      responses:
        '200':
          description: New tokens issued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthTokens'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Invalid or expired refresh token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/me:
    get:
      summary: Get current authenticated user basic info
      tags: [auth]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Current user info
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthMeResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # --------------------
  # AUTH: email verification & password reset
  # --------------------
  /auth/request-email-verification:
    post:
      summary: Request email verification for a user
      tags: [auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RequestEmailVerificationRequest'
      responses:
        '200':
          description: Verification email requested (link is logged in dev)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatusResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/verify-email:
    get:
      summary: Verify email using token
      description: >
        Public endpoint exposed through the API Gateway.
        This URL is included in the verification email and is meant to be opened
        directly in a browser or mobile webview.

        The API Gateway forwards the request to the auth-service, which validates
        the token. If the token is valid, the auth-service responds with an
        HTTP 302 Redirect pointing to the frontend application
        (FRONTEND_BASE_URL), allowing the UI to display a “Email verified”
        confirmation page.

        No direct calls to auth-service are ever performed by the client;
        the client only communicates with the Gateway, as required by the
        project architecture.
      tags: [auth]
      parameters:
        - in: query
          name: token
          required: true
          schema:
            type: string
          description: Verification token received in the email
      responses:
        '302':
          description: >
            Email successfully verified. The client (browser/webview) is
            redirected to the frontend application.
          headers:
            Location:
              description: >
                URL of the frontend page the user will be redirected to,
                e.g. `${FRONTEND_BASE_URL}/auth?verification_success=true`.
              schema:
                type: string
                format: uri
        '400':
          description: Invalid or expired token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/forgot-password:
    post:
      summary: Request password reset link
      tags: [auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ForgotPasswordRequest'
      responses:
        '200':
          description: Reset link requested (always ok, email existence not revealed)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatusResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/reset-password:
    post:
      summary: Reset password using token
      tags: [auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ResetPasswordRequest'
      responses:
        '200':
          description: Password successfully updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatusResponse'
        '400':
          description: Invalid request or token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # --------------------
  # AUTH: OAuth (Google / 42)
  # --------------------
  /auth/google/login:
    get:
      summary: Start Google OAuth2 login flow
      tags: [auth, oauth]
      parameters:
        - in: query
          name: redirect
          required: false
          schema:
            type: string
          description: Frontend redirect URL after successful login
      responses:
        '302':
          description: Redirect to Google OAuth2 authorization page

  /auth/google/callback:
    get:
      summary: Google OAuth2 callback (backend use)
      tags: [auth, oauth]
      parameters:
        - in: query
          name: code
          required: false
          schema:
            type: string
          description: Authorization code returned from Google
        - in: query
          name: state
          required: false
          schema:
            type: string
          description: Opaque state parameter (contains redirect)
        - in: query
          name: mode
          required: false
          schema:
            type: string
            enum: [json]
          description: When "json", returns tokens as JSON instead of redirect
      responses:
        '200':
          description: Tokens returned as JSON (when mode=json)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthTokens'
        '302':
          description: Redirect to frontend with tokens (fragment) in browser flow
        '400':
          description: Error during OAuth flow
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '502':
          description: Google token or userinfo error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/42/login:
    get:
      summary: Start 42 (Intra) OAuth2 login flow
      tags: [auth, oauth]
      parameters:
        - in: query
          name: redirect
          required: false
          schema:
            type: string
          description: Frontend redirect URL after successful login
      responses:
        '302':
          description: Redirect to 42 OAuth2 authorization page

  /auth/42/callback:
    get:
      summary: 42 (Intra) OAuth2 callback (backend use)
      tags: [auth, oauth]
      parameters:
        - in: query
          name: code
          required: false
          schema:
            type: string
        - in: query
          name: state
          required: false
          schema:
            type: string
        - in: query
          name: mode
          required: false
          schema:
            type: string
            enum: [json]
      responses:
        '200':
          description: Tokens returned as JSON (when mode=json)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthTokens'
        '302':
          description: Redirect to frontend with tokens (fragment) in browser flow
        '400':
          description: Error during OAuth flow
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '502':
          description: 42 token or userinfo error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # --------------------
  # USER PROFILES
  # --------------------
  /users/me:
    get:
      summary: Get current user's profile
      tags: [users]
      security:
        - bearerAuth: []   # Frontend and mobile clients must send a JWT access token; otherwise the API Gateway returns 401
      responses:
        '200':
          description: Current user profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    patch:
      summary: Update current user's profile
      tags: [users]
      security:
        - bearerAuth: []   # JWT is required
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateUserProfileRequest'
      responses:
        '200':
          description: Updated profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
        '400':
          description: Invalid profile data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /users/{id}:
    get:
      summary: Get public view of a user profile by user ID
      tags: [users]
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: User ID (same as auth userId)
      responses:
        '200':
          description: Public view of user profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PublicUserProfile'
        '404':
          description: User or profile not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /users/search:
    get:
      summary: Search users by username or display name
      tags: [users]
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: query
          required: true
          schema:
            type: string
            maxLength: 50
          description: Part of username or displayName to search for
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/UserListItem'
        '400':
          description: Invalid query
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /users/me/friends:
    get:
      summary: List current user's friends
      tags: [users]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of friends
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/UserListItem'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /users/me/friends/{id}/request:
    post:
      summary: Send friend request to another user
      tags: [users]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Target user ID
      responses:
        '200':
          description: Friend request created or accepted (if reciprocal)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatusResponse'
        '400':
          description: Invalid request (self, already friends, etc.)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /users/me/friends/{id}/accept:
    post:
      summary: Accept incoming friend request
      tags: [users]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Request sender user ID
      responses:
        '200':
          description: Friend request accepted, users are now friends
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatusResponse'
        '404':
          description: No pending request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /users/me/friends/{id}/reject:
    post:
      summary: Reject incoming friend request
      tags: [users]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Request sender user ID
      responses:
        '200':
          description: Request rejected
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatusResponse'
        '404':
          description: No pending request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /users/me/friends/{id}:
    delete:
      summary: Remove friend relationship
      tags: [users]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Friend user ID
      responses:
        '200':
          description: Friend removed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatusResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /users/me/avatar/random:
    post:
      summary: Assign a random preset avatar to current user
      description: >
        Picks a random avatar from the server-side preset avatar library
        and assigns it to the current user profile.
      tags: [users]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Avatar updated and profile returned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /users/me/avatar/upload:
    post:
      summary: Upload a custom avatar image for current user
      description: >
        Uploads a custom avatar image for the current user.
        Supported formats: PNG, JPG, JPEG, WEBP.
        Maximum size: 5 MB.
      tags: [users]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file]
              properties:
                file:
                  type: string
                  format: binary
                  description: Avatar image file to upload
      responses:
        '200':
          description: Avatar uploaded and profile updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
        '400':
          description: Invalid file (type or size)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # --------------------
  # PLAYLISTS
  # --------------------
  /playlists:
    get:
      summary: List public playlists
      tags: [playlists]
      responses:
        '200':
          description: List of public playlists
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Playlist'

    post:
      summary: Create a new playlist
      description: >
        Creates a new playlist for the current authenticated user.
        The editMode field controls who can edit the playlist
        (add/move/delete tracks).
      tags: [playlists]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePlaylistRequest'
      responses:
        '201':
          description: Playlist created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Playlist'
        '400':
          description: Invalid playlist data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '429':
          description: Too many playlist creations from this IP (rate limited by API Gateway)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /playlists/{id}:
    get:
      summary: Get playlist details with tracks
      description: >
        Returns playlist metadata and all its tracks.
        For authenticated users:
        - public playlists are visible to any user,
        - private playlists are visible only to the owner and invited users.
      tags: [playlists]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Playlist ID
      responses:
        '200':
          description: Playlist with tracks
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlaylistWithTracks'
        '403':
          description: Playlist is private and the user has no access
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Playlist not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    patch:
      summary: Update playlist metadata and edit mode
      tags: [playlists]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Playlist ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdatePlaylistRequest'
      responses:
        '200':
          description: Playlist updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Playlist'
        '400':
          description: Invalid data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden (not the owner)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Playlist not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /playlists/{id}/tracks:
    post:
      summary: Add a track to a playlist
      description: >
        Adds a new track to the end of the playlist.
        Access depends on:
        - playlist visibility (isPublic),
        - edit mode (editMode),
        - whether the user is invited (for private / invited playlists).
      tags: [playlists]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Playlist ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AddTrackRequest'
      responses:
        '201':
          description: Track added
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Track'
        '400':
          description: Invalid track data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden (no edit rights or playlist is private)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Playlist not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /playlists/{id}/tracks/{trackId}:
    patch:
      summary: Move (reorder) a track inside a playlist
      description: >
        Moves a track to a new position within the playlist,
        shifting other tracks accordingly.
        The operation is concurrency-safe using transactions and row locks.
      tags: [playlists]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Playlist ID
        - in: path
          name: trackId
          required: true
          schema:
            type: string
          description: Track ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MoveTrackRequest'
      responses:
        '200':
          description: Track moved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MoveTrackResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden (no edit rights)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Playlist or track not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Conflict or no tracks to move
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      summary: Delete a track from a playlist
      description: >
        Deletes a track from the playlist and compacts positions
        of the remaining tracks.
      tags: [playlists]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Playlist ID
        - in: path
          name: trackId
          required: true
          schema:
            type: string
          description: Track ID
      responses:
        '204':
          description: Track deleted
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden (no edit rights)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Playlist or track not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /playlists/{id}/invites:
    get:
      summary: List invited users for a playlist
      description: >
        Returns the list of invited users for a playlist.
        Only the playlist owner can access this endpoint.
      tags: [playlists]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Playlist ID
      responses:
        '200':
          description: List of invited users
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PlaylistInvite'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden (not the owner)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Playlist not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    post:
      summary: Invite a user to a playlist
      description: >
        Adds a user to the invited list for the playlist.
        The operation is idempotent: re-inviting the same user has no effect.
        Only the playlist owner can invite users.
      tags: [playlists]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Playlist ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [userId]
              properties:
                userId:
                  type: string
                  description: User ID to invite
      responses:
        '204':
          description: Invitation created or already existed
        '400':
          description: Invalid userId
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden (not the owner)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Playlist not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /playlists/{id}/invites/{userId}:
    delete:
      summary: Remove an invite for a user
      description: >
        Removes an invited user from the playlist.
        Only the playlist owner can perform this operation.
      tags: [playlists]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Playlist ID
        - in: path
          name: userId
          required: true
          schema:
            type: string
          description: Invited user ID
      responses:
        '204':
          description: Invitation removed or did not exist
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden (not the owner)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Playlist not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # --------------------
  # EVENTS & VOTING
  # --------------------
  /events:
    get:
      summary: List events visible to current user
      description: >
        Returns events that are visible for the current user:
        - public events for everyone,
        - plus events owned by the user,
        - plus events where the user is invited.
      tags: [events]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of events
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Event'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    post:
      summary: Create a new event (voting session)
      tags: [events]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateEventRequest'
      responses:
        '200':
          description: Event created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Event'
        '400':
          description: Invalid event data (time window, geo settings, etc.)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /events/{id}:
    get:
      summary: Get event details
      tags: [events]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Event ID
      responses:
        '200':
          description: Event details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Event'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Event not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    patch:
      summary: Update event settings (visibility, license, geo, voting window)
      tags: [events]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Event ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateEventRequest'
      responses:
        '200':
          description: Updated event
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Event'
        '400':
          description: Invalid data (time window, geo settings, etc.)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden (not event owner)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Event not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      summary: Delete event
      tags: [events]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Event ID
      responses:
        '204':
          description: Event deleted
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden (not event owner)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Event not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /events/{id}/invites:
    get:
      summary: List invites for an event
      tags: [events]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Event ID
      responses:
        '200':
          description: List of invited users
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/EventInvite'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden (not event owner)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Event not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    post:
      summary: Invite a user to an event
      tags: [events]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Event ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateInviteRequest'
      responses:
        '204':
          description: Invitation created (or already exists)
        '400':
          description: Invalid userId
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden (not event owner)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Event or user not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /events/{id}/invites/{userId}:
    delete:
      summary: Remove invite for a user
      tags: [events]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Event ID
        - in: path
          name: userId
          required: true
          schema:
            type: string
          description: Invited user ID
      responses:
        '204':
          description: Invitation removed (or did not exist)
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden (not event owner)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Event not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /events/{id}/vote:
    post:
      summary: Vote for a track in an event
      tags: [votes]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Event ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VoteRequest'
      responses:
        '200':
          description: Vote registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VoteResponse'
        '400':
          description: Invalid vote (missing trackId, invalid geo/time window, etc.)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden (not invited, outside geo area, voting window closed)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Event not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Duplicate vote for this event
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /events/{id}/tally:
    get:
      summary: Get tally of votes for an event
      tags: [votes]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Event ID
      responses:
        '200':
          description: Tally of votes per track
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    track:
                      type: string
                    count:
                      type: integer
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Event not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # --------------------
  # MUSIC PROVIDER (search)
  # --------------------
  /music/search:
    get:
      summary: Search music tracks via external provider
      description: >
        Searches tracks using an external music provider (e.g. YouTube).
        This endpoint is used by the frontend/mobile to pick a track and
        then add it to a playlist with provider metadata.
      tags: [music]
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: query
          required: true
          schema:
            type: string
            minLength: 1
            maxLength: 200
          description: Free-text search query (track title, artist, etc.)
        - in: query
          name: provider
          required: false
          schema:
            type: string
            enum: [youtube]
            default: youtube
          description: Music provider to use. Currently only "youtube" is supported.
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/MusicSearchItem'
        '400':
          description: Invalid query
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '502':
          description: Upstream provider error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    # ---------- COMMON ----------
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
      required: [error]

    StatusResponse:
      type: object
      properties:
        status:
          type: string
      required: [status]

    # ---------- AUTH ----------
    RegisterRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 6

    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string

    RefreshRequest:
      type: object
      required: [refreshToken]
      properties:
        refreshToken:
          type: string

    RequestEmailVerificationRequest:
      type: object
      required: [email]
      properties:
        email:
          type: string
          format: email

    ForgotPasswordRequest:
      type: object
      required: [email]
      properties:
        email:
          type: string
          format: email

    ResetPasswordRequest:
      type: object
      required: [token, newPassword]
      properties:
        token:
          type: string
        newPassword:
          type: string
          minLength: 6

    VerifyEmailResponse:
      type: object
      properties:
        status:
          type: string
          example: email verified
        emailVerified:
          type: boolean
          example: true
      required: [status, emailVerified]

    AuthTokens:
      type: object
      properties:
        accessToken:
          type: string
        refreshToken:
          type: string
      required: [accessToken, refreshToken]

    AuthMeResponse:
      type: object
      properties:
        userId:
          type: string
        email:
          type: string
          format: email
        emailVerified:
          type: boolean
      required: [userId, email, emailVerified]

    # ---------- USERS / PROFILES ----------
    UserVisibility:
      type: string
      enum: [public, friends, private]
      default: public

    MusicPreferences:
      type: object
      properties:
        genres:
          type: array
          items:
            type: string
        artists:
          type: array
          items:
            type: string
        moods:
          type: array
          items:
            type: string

    UserProfile:
      type: object
      properties:
        id:
          type: string
          description: Profile ID
        userId:
          type: string
          description: ID of the user from auth-service (auth_users.id)
        username:
          type: string
          description: Human-readable unique username (e.g. "sleepy-strawberry")
        displayName:
          type: string
          description: Display name visible to other users
        avatarUrl:
          type: string
          format: uri
        hasCustomAvatar:
          type: boolean
          description: Indicates whether the user has generated a custom avatar
        bio:
          type: string
          description: User biography / about me section
        visibility:
          $ref: '#/components/schemas/UserVisibility'
        preferences:
          $ref: '#/components/schemas/MusicPreferences'
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
      required: [id, userId, displayName, visibility, preferences, createdAt, updatedAt]

    PublicUserProfile:
      type: object
      properties:
        userId:
          type: string
          description: User ID (same as in auth / auth_me)
        username:
          type: string
          description: Human-readable unique username
        displayName:
          type: string
        avatarUrl:
          type: string
          format: uri
        bio:
          type: string
        visibility:
          $ref: '#/components/schemas/UserVisibility'
        preferences:
          $ref: '#/components/schemas/MusicPreferences'
      required: [userId, displayName, visibility]
    
    UserListItem:
      type: object
      description: Lightweight user representation for lists (search, friends)
      properties:
        userId:
          type: string
        username:
          type: string
        displayName:
          type: string
        avatarUrl:
          type: string
          format: uri
      required: [userId, displayName]

    UpdateUserProfileRequest:
      type: object
      properties:
        displayName:
          type: string
        bio:
          type: string
        visibility:
          $ref: '#/components/schemas/UserVisibility'
        preferences:
          $ref: '#/components/schemas/MusicPreferences'

    # ---------- PLAYLISTS ----------
    PlaylistEditMode:
      type: string
      enum: [everyone, invited]
      default: everyone
      description: |
        "everyone" — any authenticated user who has access to the playlist can edit it
        (add/move/delete tracks).
        "invited" — only the owner and explicitly invited users can edit the playlist.

    Playlist:
      type: object
      properties:
        id:
          type: string
        ownerId:
          type: string
          description: ID of the playlist owner (same as auth userId)
        name:
          type: string
        description:
          type: string
        isPublic:
          type: boolean
          description: |
            true  — playlist is visible to everyone,
            false — visible only to the owner and invited users.
        editMode:
          $ref: '#/components/schemas/PlaylistEditMode'
        createdAt:
          type: string
          format: date-time
      required: [id, ownerId, name, isPublic, editMode, createdAt]

    Track:
      type: object
      properties:
        id:
          type: string
        playlistId:
          type: string
        title:
          type: string
        artist:
          type: string
        position:
          type: integer
          description: Zero-based index of the track within the playlist
        createdAt:
          type: string
          format: date-time
        provider:
          type: string
          description: External music provider identifier (e.g. "youtube")
        providerTrackId:
          type: string
          description: Track or video ID in the external provider
        thumbnailUrl:
          type: string
          format: uri
          description: Optional thumbnail URL from the provider
      required: [id, playlistId, title, artist, position, createdAt]

    PlaylistWithTracks:
      type: object
      properties:
        playlist:
          $ref: '#/components/schemas/Playlist'
        tracks:
          type: array
          items:
            $ref: '#/components/schemas/Track'
      required: [playlist, tracks]

    PlaylistInvite:
      type: object
      properties:
        userId:
          type: string
          description: ID of the invited user
        createdAt:
          type: string
          format: date-time
      required: [userId, createdAt]

    CreatePlaylistRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string
          description: Playlist name (1–200 characters)
        description:
          type: string
          description: Optional playlist description (up to 1000 characters)
        isPublic:
          type: boolean
          default: true
          description: Whether the playlist is public or private
        editMode:
          $ref: '#/components/schemas/PlaylistEditMode'

    UpdatePlaylistRequest:
      type: object
      properties:
        name:
          type: string
          description: New playlist name
        description:
          type: string
          description: New playlist description
        isPublic:
          type: boolean
          description: New public/private flag
        editMode:
          $ref: '#/components/schemas/PlaylistEditMode'

    AddTrackRequest:
      type: object
      required: [title]
      properties:
        title:
          type: string
          description: Track title (1–300 characters)
        artist:
          type: string
          description: Optional artist name (up to 200 characters)
        provider:
          type: string
          description: >
            Optional external provider for this track, e.g. "youtube".
            When set, providerTrackId MUST be provided.
        providerTrackId:
          type: string
          description: >
            Track or video ID in the external provider (e.g. YouTube video ID).
        thumbnailUrl:
          type: string
          format: uri
          description: Optional thumbnail URL from the provider

    MoveTrackRequest:
      type: object
      required: [newPosition]
      properties:
        newPosition:
          type: integer
          minimum: 0
          description: New zero-based position of the track within the playlist

    MoveTrackResponse:
      type: object
      properties:
        trackId:
          type: string
        from:
          type: integer
          description: Previous position
        to:
          type: integer
          description: New position
      required: [trackId, from, to]

    # ---------- EVENTS & VOTING ----------
    EventVisibility:
      type: string
      enum: [public, private]
      default: public

    EventLicenseMode:
      type: string
      enum: [everyone, invited_only, geo_time]
      default: everyone

    Event:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        visibility:
          $ref: '#/components/schemas/EventVisibility'
        ownerId:
          type: string
        licenseMode:
          $ref: '#/components/schemas/EventLicenseMode'
        geoLat:
          type: number
          format: double
          nullable: true
        geoLng:
          type: number
          format: double
          nullable: true
        geoRadiusM:
          type: integer
          nullable: true
        voteStart:
          type: string
          format: date-time
          nullable: true
          description: Voting start time (RFC3339). Must not be in the past.
        voteEnd:
          type: string
          format: date-time
          nullable: true
          description: Voting end time (RFC3339). Must not be in the past and not more than 1 year in the future.
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
      required: [id, name, visibility, ownerId, licenseMode, createdAt, updatedAt]

    CreateEventRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string
          description: Human readable name of the event (e.g. "Friday Party")
        visibility:
          $ref: '#/components/schemas/EventVisibility'
        licenseMode:
          $ref: '#/components/schemas/EventLicenseMode'
        geoLat:
          type: number
          format: double
          description: Optional latitude of the event center (for geo_time license)
        geoLng:
          type: number
          format: double
          description: Optional longitude of the event center (for geo_time license)
        geoRadiusM:
          type: integer
          description: Optional radius in meters for geo_time license
        voteStart:
          type: string
          format: date-time
          description: >
            Optional voting start time (RFC3339).
            Must not be in the past and not more than 1 year in the future.
        voteEnd:
          type: string
          format: date-time
          description: >
            Optional voting end time (RFC3339).
            Must not be in the past, not more than 1 year in the future,
            and if voteStart is set, the window must be at least 1 hour.

    UpdateEventRequest:
      type: object
      properties:
        name:
          type: string
        visibility:
          $ref: '#/components/schemas/EventVisibility'
        licenseMode:
          $ref: '#/components/schemas/EventLicenseMode'
        geoLat:
          type: number
          format: double
        geoLng:
          type: number
          format: double
        geoRadiusM:
          type: integer
        voteStart:
          type: string
          format: date-time
          description: >
            New voting start time (RFC3339). If empty string is sent,
            server may reset it to null.
        voteEnd:
          type: string
          format: date-time
          description: >
            New voting end time (RFC3339). If empty string is sent,
            server may reset it to null.

    EventInvite:
      type: object
      properties:
        userId:
          type: string
        createdAt:
          type: string
          format: date-time
      required: [userId, createdAt]

    CreateInviteRequest:
      type: object
      required: [userId]
      properties:
        userId:
          type: string
          description: User ID to invite (must exist in user-service)

    # ---------- VOTES ----------
    VoteRequest:
      type: object
      required: [trackId]
      properties:
        trackId:
          type: string
        lat:
          type: number
          format: double
          description: Optional latitude of the voter for geo-locked events
        lng:
          type: number
          format: double
          description: Optional longitude of the voter for geo-locked events
    VoteResponse:
      type: object
      properties:
        status:
          type: string
          example: ok
        trackId:
          type: string
        totalVotes:
          type: integer
      required: [status, trackId, totalVotes]

    # ---------- PROVIDER SEARCH ----------
    MusicSearchItem:
      type: object
      properties:
        title:
          type: string
        artist:
          type: string
          description: Source channel/artist name if available
        provider:
          type: string
          description: Provider identifier, e.g. "youtube"
        providerTrackId:
          type: string
          description: ID of the track/video in the provider
        thumbnailUrl:
          type: string
          format: uri
          description: Thumbnail URL for display
      required: [title, provider, providerTrackId]
