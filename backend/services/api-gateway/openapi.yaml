openapi: 3.0.3
info:
  title: Music Room Gateway API
  version: 1.0.0

servers:
  - url: http://localhost:8080
    description: Local development gateway

paths:
  /health:
    get:
      summary: Health check for API gateway
      tags: [system]
      responses:
        '200':
          description: Gateway is healthy
          content:
            text/plain:
              schema:
                type: string
                example: ok

  # --------------------
  # AUTH: email + password, tokens
  # --------------------
  /auth/register:
    post:
      summary: Register a new user with email and password
      tags: [auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '201':
          description: User successfully registered, tokens returned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthTokens'
        '400':
          description: Invalid input data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Email already registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/login:
    post:
      summary: Login with email and password
      tags: [auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login successful, returns tokens
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthTokens'
        '400':
          description: Invalid input data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/refresh:
    post:
      summary: Refresh access token using refresh token
      tags: [auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshRequest'
      responses:
        '200':
          description: New tokens issued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthTokens'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Invalid or expired refresh token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/me:
    get:
      summary: Get current authenticated user basic info
      tags: [auth]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Current user info
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthMeResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # --------------------
  # AUTH: email verification & password reset
  # --------------------
  /auth/request-email-verification:
    post:
      summary: Request email verification for a user
      tags: [auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RequestEmailVerificationRequest'
      responses:
        '200':
          description: Verification email requested (link is logged in dev)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatusResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/verify-email:
    get:
      summary: Verify email using token
      tags: [auth]
      parameters:
        - in: query
          name: token
          required: true
          schema:
            type: string
          description: Verification token from email link
      responses:
        '200':
          description: Email successfully verified
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VerifyEmailResponse'
        '400':
          description: Invalid or expired token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/forgot-password:
    post:
      summary: Request password reset link
      tags: [auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ForgotPasswordRequest'
      responses:
        '200':
          description: Reset link requested (always ok, email existence not revealed)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatusResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/reset-password:
    post:
      summary: Reset password using token
      tags: [auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ResetPasswordRequest'
      responses:
        '200':
          description: Password successfully updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatusResponse'
        '400':
          description: Invalid request or token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # --------------------
  # AUTH: OAuth (Google / 42)
  # Для фронта/mобилки — в основном browser/webview flow.
  # --------------------
  /auth/google/login:
    get:
      summary: Start Google OAuth2 login flow
      tags: [auth, oauth]
      parameters:
        - in: query
          name: redirect
          required: false
          schema:
            type: string
          description: Frontend redirect URL after successful login
      responses:
        '302':
          description: Redirect to Google OAuth2 authorization page

  /auth/google/callback:
    get:
      summary: Google OAuth2 callback (backend use)
      tags: [auth, oauth]
      parameters:
        - in: query
          name: code
          required: false
          schema:
            type: string
          description: Authorization code returned from Google
        - in: query
          name: state
          required: false
          schema:
            type: string
          description: Opaque state parameter (contains redirect)
        - in: query
          name: mode
          required: false
          schema:
            type: string
            enum: [json]
          description: When "json", returns tokens as JSON instead of redirect
      responses:
        '200':
          description: Tokens returned as JSON (when mode=json)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthTokens'
        '302':
          description: Redirect to frontend with tokens (fragment) in browser flow
        '400':
          description: Error during OAuth flow
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '502':
          description: Google token or userinfo error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/42/login:
    get:
      summary: Start 42 (Intra) OAuth2 login flow
      tags: [auth, oauth]
      parameters:
        - in: query
          name: redirect
          required: false
          schema:
            type: string
          description: Frontend redirect URL after successful login
      responses:
        '302':
          description: Redirect to 42 OAuth2 authorization page

  /auth/42/callback:
    get:
      summary: 42 (Intra) OAuth2 callback (backend use)
      tags: [auth, oauth]
      parameters:
        - in: query
          name: code
          required: false
          schema:
            type: string
        - in: query
          name: state
          required: false
          schema:
            type: string
        - in: query
          name: mode
          required: false
          schema:
            type: string
            enum: [json]
      responses:
        '200':
          description: Tokens returned as JSON (when mode=json)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthTokens'
        '302':
          description: Redirect to frontend with tokens (fragment) in browser flow
        '400':
          description: Error during OAuth flow
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '502':
          description: 42 token or userinfo error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # --------------------
  # USER PROFILES
  # --------------------
  /users/me:
    get:
      summary: Get current user's profile
      tags: [users]
      security:
        - bearerAuth: []   # Фронт/мобилка должны передавать токен(обязателен JWT-эндпоинт), иначе API Gateway ответит 401
      responses:
        '200':
          description: Current user profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    patch:
      summary: Update current user's profile
      tags: [users]
      security:
        - bearerAuth: []   # обязательный JWT
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateUserProfileRequest'
      responses:
        '200':
          description: Updated profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
        '400':
          description: Invalid profile data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /users/{id}:
    get:
      summary: Get public view of a user profile by user ID
      tags: [users]
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: User ID (same as auth userId)
      responses:
        '200':
          description: Public view of user profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PublicUserProfile'
        '404':
          description: User or profile not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # --------------------
  # PLAYLISTS
  # --------------------
  /playlists:
    get:
      summary: List public playlists
      tags: [playlists]
      responses:
        '200':
          description: List of public playlists
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Playlist'

    post:
      summary: Create a new playlist
      tags: [playlists]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePlaylistRequest'
      responses:
        '201':
          description: Playlist created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Playlist'
        '400':
          description: Invalid playlist data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /playlists/{id}:
    patch:
      summary: Update playlist metadata
      tags: [playlists]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Playlist ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdatePlaylistRequest'
      responses:
        '200':
          description: Playlist updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Playlist'
        '400':
          description: Invalid data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden (not owner)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Playlist not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # --------------------
  # VOTING
  # --------------------
  /events/{id}/vote:
    post:
      summary: Vote for a track in an event
      tags: [votes]
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Event ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VoteRequest'
      responses:
        '200':
          description: Vote registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VoteResponse'
        '400':
          description: Invalid vote
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Event or track not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    # ---------- COMMON ----------
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
      required: [error]

    StatusResponse:
      type: object
      properties:
        status:
          type: string
      required: [status]

    # ---------- AUTH ----------
    RegisterRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 6

    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string

    RefreshRequest:
      type: object
      required: [refreshToken]
      properties:
        refreshToken:
          type: string

    RequestEmailVerificationRequest:
      type: object
      required: [email]
      properties:
        email:
          type: string
          format: email

    ForgotPasswordRequest:
      type: object
      required: [email]
      properties:
        email:
          type: string
          format: email

    ResetPasswordRequest:
      type: object
      required: [token, newPassword]
      properties:
        token:
          type: string
        newPassword:
          type: string
          minLength: 6

    VerifyEmailResponse:
      type: object
      properties:
        status:
          type: string
          example: email verified
        emailVerified:
          type: boolean
          example: true
      required: [status, emailVerified]

    AuthTokens:
      type: object
      properties:
        accessToken:
          type: string
        refreshToken:
          type: string
      required: [accessToken, refreshToken]

    AuthMeResponse:
      type: object
      properties:
        userId:
          type: string
        email:
          type: string
          format: email
        emailVerified:
          type: boolean
      required: [userId, email, emailVerified]

    # ---------- USERS / PROFILES ----------
    UserVisibility:
      type: string
      enum: [public, friends, private]
      default: public

    MusicPreferences:
      type: object
      properties:
        genres:
          type: array
          items:
            type: string
        artists:
          type: array
          items:
            type: string
        moods:
          type: array
          items:
            type: string

    UserProfile:
      type: object
      properties:
        id:
          type: string
          description: Profile ID
        userId:
          type: string
          description: ID пользователя из auth-service (auth_users.id)
        displayName:
          type: string
          description: Отображаемое имя пользователя
        avatarUrl:
          type: string
          format: uri
        publicBio:
          type: string
          description: Публичная информация (видна всем)
        friendsBio:
          type: string
          description: Информация, которая в будущем будет видна только друзьям
        privateBio:
          type: string
          description: Приватная информация (видит только владелец)
        visibility:
          $ref: '#/components/schemas/UserVisibility'
        preferences:
          $ref: '#/components/schemas/MusicPreferences'
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
      required: [id, userId, displayName, visibility, preferences, createdAt, updatedAt]

    PublicUserProfile:
      type: object
      properties:
        userId:
          type: string
          description: ID пользователя (как в auth / auth_me)
        displayName:
          type: string
        avatarUrl:
          type: string
          format: uri
        publicBio:
          type: string
        visibility:
          $ref: '#/components/schemas/UserVisibility'
        preferences:
          $ref: '#/components/schemas/MusicPreferences'
      required: [userId, displayName, visibility]

    UpdateUserProfileRequest:
      type: object
      properties:
        displayName:
          type: string
        avatarUrl:
          type: string
          format: uri
        publicBio:
          type: string
        friendsBio:
          type: string
        privateBio:
          type: string
        visibility:
          $ref: '#/components/schemas/UserVisibility'
        preferences:
          $ref: '#/components/schemas/MusicPreferences'

    # ---------- PLAYLISTS ----------
    Playlist:
      type: object
      properties:
        id:
          type: string
        ownerId:
          type: string
        name:
          type: string
        description:
          type: string
        isPublic:
          type: boolean
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
      required: [id, ownerId, name, isPublic, createdAt, updatedAt]

    CreatePlaylistRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string
        description:
          type: string
        isPublic:
          type: boolean
          default: true

    UpdatePlaylistRequest:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        isPublic:
          type: boolean

    # ---------- VOTES ----------
    VoteRequest:
      type: object
      required: [trackId]
      properties:
        trackId:
          type: string

    VoteResponse:
      type: object
      properties:
        status:
          type: string
          example: ok
        trackId:
          type: string
        totalVotes:
          type: integer
      required: [status, trackId, totalVotes]
